name: CI
on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, labeled, synchronize]
    branches:
      - 'ROMFPMD'
  # push:
  #   branches:
  #     - release

jobs:
  docker-image:
    uses: ./.github/workflows/docker_image.yml
  build:
    runs-on: ubuntu-latest
    needs: [docker-image]
    container:
      image: ghcr.io/llnl/mgmol/mgmol_env:latest
      options: --user 1001 --privileged
      volumes:
        - /mnt:/mnt
    steps:
      - name: Cancel previous runs
        uses: styfle/cancel-workflow-action@0.11.0
        with:
          access_token: ${{ github.token }}
      # - name: Set Swap Space
      #   uses: pierotofy/set-swap-space@master
      #   with:
      #     swap-size-gb: 10
      - name: Check out mgmol
        uses: actions/checkout@v1
        with:
            submodules: 'true'
      - name: cmake
        run: |
            mkdir ${GITHUB_WORKSPACE}/build
            cd ${GITHUB_WORKSPACE}/build
            cmake .. -DCMAKE_CXX_COMPILER=mpic++ -DCMAKE_Fortran_COMPILER=mpif90 -DMPIEXEC_PREFLAGS="--oversubscribe" -DUSE_LIBROM=On -DLIBROM_PATH=/env/dependencies/libROM
      - name: make
        run: |
            cd ${GITHUB_WORKSPACE}/build && make -j 4
      - name: test
        run: |
            cd ${GITHUB_WORKSPACE}/build && ctest --no-compress-output -V -T Test -I 1,20,1
      - name: test ROM Poisson operator
        run: |
            cd ${GITHUB_WORKSPACE}/tests/ROM/test_rom_poisson
            ln -s ${GITHUB_WORKSPACE}/build/src/mgmol-rom .
            ln -s ${GITHUB_WORKSPACE}/potentials/* .
            mpirun -n 3 --oversubscribe ./mgmol-rom -c carbyne.poisson.cfg -i carbyne.in
      - name: test ROM ion density evaluation
        run: |
            cd ${GITHUB_WORKSPACE}/tests/ROM/test_rom_poisson
            mpirun -n 3 --oversubscribe ./mgmol-rom -c carbyne.ion.cfg -i carbyne.in
  # code-style:
  #   runs-on: ubuntu-latest
  #   needs: [docker-image]
  #   container:
  #     image: ghcr.io/llnl/mgmol/mgmol_env:latest
  #     options: --user 1001 --privileged
  #     volumes:
  #       - /mnt:/mnt
  #   steps:
  #     - name: Cancel previous runs
  #       uses: styfle/cancel-workflow-action@0.11.0
  #       with:
  #         access_token: ${{ github.token }}
  #     - name: Check out mgmol
  #       uses: actions/checkout@v1
  #       with:
  #           submodules: 'true'
  #     - name: cmake
  #       run: |
  #           mkdir build
  #           cd build
  #           cmake .. -DCMAKE_CXX_COMPILER=mpic++ -DCMAKE_Fortran_COMPILER=mpif90 -DMGMOL_WITH_CLANG_FORMAT=ON
  #     - name: make
  #       run: |
  #           cd build && make format
    
